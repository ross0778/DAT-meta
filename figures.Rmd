---
title: "figures"
output: html_document
---


```{r}
# ══════════════════════════════════════════════════════════════════════════════
# PLOT 1: DIDACTIC + PRE-CLINICAL COMBINED
# ══════════════════════════════════════════════════════════════════════════════

didactic_preclinical_data <- bind_rows(didactic_data, didactic_corrected, 
                                       preclinical_data, preclinical_corrected)

all_predictors_dp <- unique(c(didactic_data$predictor, preclinical_data$predictor))
level_order_dp <- rev(all_predictors_dp)

didactic_preclinical_data$predictor <- factor(didactic_preclinical_data$predictor, 
                                              levels = level_order_dp)

p_didactic_preclinical <- ggplot(didactic_preclinical_data,
                                 aes(x = r, y = predictor, color = outcome)) +
  
  # CI drawn ONCE (Observed only)
  geom_errorbarh(
    data = filter(didactic_preclinical_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8
  ) +
  
  # Points (Observed + Corrected on same line)
  geom_point(aes(shape = correction), size = 3) +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(didactic_preclinical_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.5,
    show.legend = FALSE
  ) +
  
  scale_color_manual(
    values = c("Didactic Course Grades" = "#d7191c",
               "Pre-Clinical Course Grades" = "#2c7bb6")
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for Dental School Academic Performance",
    y = NULL,
    color = "Outcome"
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_didactic_preclinical.png", plot = p_didactic_preclinical,
       width = 11, height = 9, dpi = 300, bg = "white")


# ══════════════════════════════════════════════════════════════════════════════
# PLOT 2: DIDACTIC ONLY
# ══════════════════════════════════════════════════════════════════════════════

didactic_only_data <- bind_rows(didactic_data, didactic_corrected)
didactic_only_data$predictor <- factor(didactic_only_data$predictor,
                                       levels = rev(unique(didactic_data$predictor)))

p_didactic <- ggplot(didactic_only_data,
                     aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(didactic_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(didactic_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 0.65),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for Didactic Course Grades",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_didactic.png", plot = p_didactic,
       width = 10, height = 6, dpi = 300, bg = "white")


# ══════════════════════════════════════════════════════════════════════════════
# PLOT 3: GPA YEAR 1 ONLY
# ══════════════════════════════════════════════════════════════════════════════

gpa_only_data <- bind_rows(gpa_data, gpa_corrected)
gpa_only_data$predictor <- factor(gpa_only_data$predictor,
                                  levels = rev(unique(gpa_data$predictor)))

p_gpa <- ggplot(gpa_only_data,
                aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(gpa_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(gpa_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for First Year GPA",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_gpa.png", plot = p_gpa,
       width = 10, height = 8.5, dpi = 300, bg = "white")


# ══════════════════════════════════════════════════════════════════════════════
# PLOT: PRE-CLINICAL ONLY
# ══════════════════════════════════════════════════════════════════════════════

preclinical_only_data <- bind_rows(preclinical_data, preclinical_corrected)
preclinical_only_data$predictor <- factor(preclinical_only_data$predictor,
                                          levels = rev(unique(preclinical_data$predictor)))

p_preclinical <- ggplot(preclinical_only_data,
                        aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(preclinical_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(preclinical_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for Pre-Clinical Course Grades",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_preclinical.png", plot = p_preclinical,
       width = 10, height = 7, dpi = 300, bg = "white")

```

