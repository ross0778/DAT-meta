---
title: "figures"
output: html_document
---


```{r}
library(tidyverse)
library(ggplot2)

# ══════════════════════════════════════════════════════════════════════════════
# FIRST YEAR GPA DATA
# ══════════════════════════════════════════════════════════════════════════════

# ── GPA data (Observed) ───────────────────────────────────────────────────────
gpa_data <- tibble(
  predictor = c("Academic Average", "Biology", "Carving Dexterity", "Chemistry",
                "Factual Science", "Inorganic Chemistry", "Manual Average",
                "Organic Chemistry", "PAT", "Quantitative Reasoning",
                "Reading Comprehension", "Science Application",
                "Space Relations", "Total Science"),
  r     = c( .41,  .33,  .19,  .28,  .27,  .33,  .27,  .28,  .19,  .21,  .29,  .20,  .20,  .40),
  lower = c( .38,  .29, -.07,  .08,  .11,  .30,  .10,  .25,  .16,  .18,  .24,  .04,  .04,  .37),
  upper = c( .44,  .37,  .45,  .48,  .43,  .36,  .44,  .31,  .22,  .24,  .34,  .36,  .36,  .43),
  k     = c(   7,    5,    3,    3,    3,    2,    3,    2,    4,    5,    5,    3,    3,    5),
  N     = c(4438, 3928,  136,  136,  136, 3792,  136, 3792, 4302, 3928, 3928,  136,  136, 3928),
  outcome = "First Year GPA",
  correction = "Observed"
)

# ── GPA Range Corrected (ONLY for predictors with corrections) ────────────────
gpa_corrected <- tibble(
  predictor = c("Academic Average", "Biology", "Chemistry", "PAT", "Quantitative Reasoning", "Reading Comprehension"),
  r     = c( .60, .46, .36, .25, .31, .37),
  lower = c( .38, .29, .08, .16, .18, .24),
  upper = c( .44, .37, .48, .22, .24, .34),
  k     = c(7,5,3,4,5,5),
  N     = c(4438, 3928, 136, 4302, 3928, 3928),
  outcome = "First Year GPA",
  correction = "Corrected for Range Restriction"
)

# ══════════════════════════════════════════════════════════════════════════════
# DIDACTIC COURSE GRADES DATA
# ══════════════════════════════════════════════════════════════════════════════

didactic_data <- tibble(
  predictor = c("Academic Average", "Biology", "Carving Dexterity", "Chemistry",
                "Factual Science", "PAT", "Quantitative Reasoning",
                "Reading Comprehension", "Science Application",
                "Space Relations", "Total Science"),
  r     = c( .17,  .12, -.05,  .17,  .17,  .04,  .05,  .12,  .15, -.01,  .18),
  lower = c( .09,  .00, -.24,  .05,  .05, -.08, -.11,  .00,  .03, -.13,  .10),
  upper = c( .25,  .24,  .14,  .29,  .29,  .16,  .21,  .24,  .27,  .11,  .26),
  k     = c(   4,    2,    2,    2,    2,    2,    2,    2,    2,    2,    4),
  N     = c( 517,  266,  266,  266,  266,  256,  266,  266,  266,  266,  522),
  outcome = "Didactic Course Grades",
  correction = "Observed"
)

didactic_corrected <- tibble(
  predictor = c("Academic Average", "Biology", "Chemistry", "PAT", "Quantitative Reasoning", "Reading Comprehension"),
  r     = c(.27, .17, .25, .05, .07, .16),
  lower = c(.09, .00, .05, -.08, -.11, .00),
  upper = c(.25, .24, .29, -.08, -.11, .00),
  k     = c(4, 2, 2, 2, 2, 2),
  N     = c(517, 266, 266, 266, 266, 266),
  outcome = "Didactic Course Grades",
  correction = "Corrected for Range Restriction"
)

# ══════════════════════════════════════════════════════════════════════════════
# PRE-CLINICAL COURSE GRADES DATA
# ══════════════════════════════════════════════════════════════════════════════

preclinical_data <- tibble(
  predictor = c("Academic Average", "Biology", "Carving Dexterity", "Chemistry", "Factual Science", "Mechanical Aptitude", "PAT", "Quantitative Reasoning", "Reading Comprehension", "Science Application", "Space Relations", "Total Science"),
  r     = c(.06, .00, .22, .09, .03, .41, .37, .07, .12, .06, .26, .08),
  lower = c(-.01, -.12, .06, -.03, -.09, .27, .25, -.05, .00, -.06, .15, -.01),
  upper = c(.13, .12, .38, .21, .15, .55, .49, .19, .24, .18, .37, .17),
  k     = c(9, 2, 2, 2, 2, 5, 3, 2, 2, 2, 2, 4),
  N     = c(731, 266, 266, 266, 266, 165, 433, 266, 266, 266, 266, 522),
  outcome = "Pre-Clinical Course Grades",
  correction = "Observed"
)

preclinical_corrected <- tibble(
  predictor = c("Academic Average", "Biology", "Chemistry", "PAT", "Quantitative Reasoning", "Reading Comprehension"),
  r     = c(.09, .00, .13, .53, .11, .16),
  lower = c(-.01, -.12, -.03, .25, -.05, .00),
  upper = c(.13, .12, .21, .49, .19, .24),
  k     = c(9,2,2,3,2,2),
  N     = c(731,266,266,433,266,266),
  outcome = "Pre-Clinical Course Grades",
  correction = "Corrected for Range Restriction"
)



# ══════════════════════════════════════════════════════════════════════════════
# PLOT: DIDACTIC + PRE-CLINICAL COMBINED
# ══════════════════════════════════════════════════════════════════════════════

didactic_preclinical_data <- bind_rows(didactic_data, didactic_corrected, 
                                       preclinical_data, preclinical_corrected)

all_predictors_dp <- unique(c(didactic_data$predictor, preclinical_data$predictor))
level_order_dp <- rev(all_predictors_dp)

didactic_preclinical_data$predictor <- factor(didactic_preclinical_data$predictor, 
                                              levels = level_order_dp)

# Small horizontal offset for corrected estimates
didactic_preclinical_data <- didactic_preclinical_data %>%
  mutate(r_plot = ifelse(correction == "Corrected for Range Restriction",
                         r + 0.015,   # slight horizontal offset
                         r))

p_didactic_preclinical <- ggplot(didactic_preclinical_data,
                                 aes(x = r_plot, y = predictor, color = outcome)) +
  
  # CI drawn ONCE (Observed only)
  geom_errorbarh(
    data = filter(didactic_preclinical_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8
  ) +
  
  # Points (Observed + horizontally offset Corrected)
  geom_point(aes(shape = correction), size = 3) +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(didactic_preclinical_data, correction == "Observed"),
    aes(x = r, label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.5,
    show.legend = FALSE
  ) +
  
  scale_color_manual(
    values = c("Didactic Course Grades" = "#d7191c",
               "Pre-Clinical Course Grades" = "#2c7bb6")
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for Dental School Academic Performance",
    y = NULL,
    color = "Outcome"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.y = element_line(color = "grey92", linewidth = 0.4),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "grey92", linewidth = 0.4),
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(size = 12, face = "bold", margin = margin(b = 12)),
    axis.text.y = element_text(size = 10),
    plot.margin = margin(15, 30, 15, 15)
  ) +
  
  guides(
    color = guide_legend(order = 1),
    shape = guide_legend(order = 2)
  )

ggsave("forest_plot_didactic_preclinical.png", plot = p_didactic_preclinical,
       width = 11, height = 9, dpi = 300, bg = "white")

# ══════════════════════════════════════════════════════════════════════════════
# PLOT 2: DIDACTIC ONLY
# ══════════════════════════════════════════════════════════════════════════════

didactic_only_data <- bind_rows(didactic_data, didactic_corrected)
didactic_only_data$predictor <- factor(didactic_only_data$predictor,
                                       levels = rev(unique(didactic_data$predictor)))

p_didactic <- ggplot(didactic_only_data,
                     aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(didactic_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(didactic_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 0.65),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for Didactic Course Grades",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_didactic.png", plot = p_didactic,
       width = 10, height = 6, dpi = 300, bg = "white")


# ══════════════════════════════════════════════════════════════════════════════
# PLOT 3: GPA YEAR 1 ONLY
# ══════════════════════════════════════════════════════════════════════════════

gpa_only_data <- bind_rows(gpa_data, gpa_corrected)
gpa_only_data$predictor <- factor(gpa_only_data$predictor,
                                  levels = rev(unique(gpa_data$predictor)))

p_gpa <- ggplot(gpa_only_data,
                aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(gpa_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(gpa_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for First Year GPA",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_gpa.png", plot = p_gpa,
       width = 10, height = 8.5, dpi = 300, bg = "white")


# ══════════════════════════════════════════════════════════════════════════════
# PLOT: PRE-CLINICAL ONLY
# ══════════════════════════════════════════════════════════════════════════════

preclinical_only_data <- bind_rows(preclinical_data, preclinical_corrected)
preclinical_only_data$predictor <- factor(preclinical_only_data$predictor,
                                          levels = rev(unique(preclinical_data$predictor)))

p_preclinical <- ggplot(preclinical_only_data,
                        aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(preclinical_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(preclinical_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for Pre-Clinical Course Grades",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12)

ggsave("forest_plot_preclinical.png", plot = p_preclinical,
       width = 10, height = 7, dpi = 300, bg = "white")

```


# New GPA Y1 Graph for SIOP poster with legend moved to the left, nothing else changed:
```{r}
gpa_only_data <- bind_rows(gpa_data, gpa_corrected)
gpa_only_data$predictor <- factor(gpa_only_data$predictor,
                                  levels = rev(unique(gpa_data$predictor)))
p_gpa <- ggplot(gpa_only_data,
                aes(x = r, y = predictor)) +
  
  geom_errorbarh(
    data = filter(gpa_only_data, correction == "Observed"),
    aes(xmin = lower, xmax = upper),
    height = 0.3,
    linewidth = 0.8,
    color = "#2c7bb6"
  ) +
  
  geom_point(aes(shape = correction),
             size = 3,
             color = "#2c7bb6") +
  
  geom_vline(xintercept = 0, linetype = "dotted", color = "grey40") +
  
  geom_text(
    data = filter(gpa_only_data, correction == "Observed"),
    aes(label = paste0("k=", k, ", N=", formatC(N, format = "d", big.mark = ","))),
    hjust = 0.5,
    vjust = -1.5,
    size = 2.9,
    show.legend = FALSE
  ) +
  
  scale_shape_manual(
    values = c("Observed" = 16,
               "Corrected for Range Restriction" = 17),
    name = "Estimate Type"
  ) +
  
  scale_x_continuous(
    name = "Meta-Analytic Correlation (r)",
    limits = c(-0.3, 1.05),
    breaks = seq(-0.2, 0.6, by = 0.2),
    expand = c(0, 0)
  ) +
  
  labs(
    title = "Predictive Validity of DAT Subsections for First Year GPA",
    y = NULL
  ) +
  
  theme_minimal(base_size = 12) +
  theme(legend.position = c(0.78, 0.15))

ggsave("forest_plot_gpa_poster.png", plot = p_gpa,
       width = 10, height = 8.5, dpi = 300, bg = "white")
```

